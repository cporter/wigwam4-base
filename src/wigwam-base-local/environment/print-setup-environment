#! /bin/sh

# setup-env (which is generated by bootstrap)
# generally contains a line like:
#   eval "`ext/libexec/print-setup-environment --pid=$$ --shell $SHELL$shell`"
#
# print-setup-environment will save an unsetup-image, the first time
# it's run.  the first time condition is detected via an environment 
# variable WIGWAM_INTERACTIVE_PID
#
# otherwise, it defers to print-interactive-environment

if test "x$PLAYPEN_ROOT" = x 
  then
    PLAYPEN_ROOT=`pwd`
  else
    make_setup_env_pwd=`pwd`
       test "x$PLAYPEN_ROOT" = "x$make_setup_env_pwd"                   \
    ||                                                                  \
      {
        echo "$0: \$PLAYPEN_ROOT was already set to an old path." 1>&2
        echo "   Probably you were working on a project in $PLAYPEN_ROOT." 1>&2
        echo "" 1>&2
        echo "You should start a new shell with a fresh environment before" 1>&2
        echo "trying to use the new playpen in $ww_setup_tmp_pwd." 1>&2
        exit 1
      }
  fi

. "$PLAYPEN_ROOT/ext/libexec/functions/configurable-functions"

configurable_source --once libexec/functions/wigwam-base-functions

make_setup_env_pid=`                                            \
  (
    while test $# -gt 0
      do
        case "$1" in
          --pid)
            if test $# -gt 1
              then
                make_setup_env_pid="$2"
                shift
              fi

            ;;
          --pid=*)
            make_setup_env_pid=\`echo $1 | perl -pe 's/--pid=//'\`

            ;;
          *)

            ;;
        esac
        shift
      done

    test "x$make_setup_env_pid" = "x" || echo "$make_setup_env_pid"
  )`

if test "x$WIGWAM_INTERACTIVE_PID" = "x" 
  then
    if test "x$make_setup_env_pid" = "x"
      then
        wigwam_base_fatal "$0: missing pid argument and"                 \
                          "WIGWAM_INTERACTIVE_PID environment variable"
        exit 1
      fi

    mkdir "$PLAYPEN_ROOT/ext" 2>/dev/null 1>/dev/null
    mkdir "$PLAYPEN_ROOT/ext/tmp" 2>/dev/null 1>/dev/null

    rm -f "$PLAYPEN_ROOT/ext/tmp/unsetup-image-$make_setup_env_pid"

      configurable_run libexec/environment/ww-env-diffs                        \
       --save-before="$PLAYPEN_ROOT/ext/tmp/unsetup-image-$make_setup_env_pid" \
    ||                                                                         \
      {                                                                        \
        wigwam_base_fatal "$0: saving unset image failed"
        exit 1
      }

    WIGWAM_INTERACTIVE_PID="$make_setup_env_pid"
    export WIGWAM_INTERACTIVE_PID
  fi

configurable_source --once libexec/environment/functions

# chicken and egg

ww_int_pre_colon PATH "$PLAYPEN_ROOT/ext/sbin"
ww_int_pre_colon PATH "$PLAYPEN_ROOT/ext/bin"
ww_int_pre_colon PATH "$PLAYPEN_ROOT/sbin"
ww_int_pre_colon PATH "$PLAYPEN_ROOT/bin"
ww_int PLAYPEN_ROOT
ww_int PATH

configurable_run libexec/environment/print-interactive-environment "$@"
